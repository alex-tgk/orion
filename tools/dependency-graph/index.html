<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORION Dependency Graph - Interactive Visualization</title>
    <script src="https://unpkg.com/vis-network@10.0.2/dist/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .header h1 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            min-width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }

        .stat-value {
            font-weight: 700;
            color: #667eea;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #network {
            flex: 1;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .node-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .node-info h4 {
            font-size: 16px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .node-info p {
            font-size: 13px;
            color: #555;
            margin: 5px 0;
        }

        .legend {
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 13px;
            color: #555;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 2px solid #fcc;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"],
            select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó ORION Dependency Graph</h1>
            <p class="subtitle">Interactive visualization of microservices, packages, and infrastructure dependencies</p>

            <div class="controls">
                <div class="control-group">
                    <label for="search">üîç Search:</label>
                    <input type="text" id="search" placeholder="Search nodes...">
                </div>

                <div class="control-group">
                    <label for="filter">üìä Filter:</label>
                    <select id="filter">
                        <option value="all">All Nodes</option>
                        <option value="service">Services Only</option>
                        <option value="package">Packages Only</option>
                        <option value="infrastructure">Infrastructure Only</option>
                        <option value="shared">Shared Only</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="layout">üé® Layout:</label>
                    <select id="layout">
                        <option value="hierarchical">Hierarchical</option>
                        <option value="force">Force-Directed</option>
                        <option value="circular">Circular</option>
                    </select>
                </div>

                <button id="resetBtn">üîÑ Reset View</button>
                <button id="exportBtn">üíæ Export PNG</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <span>Nodes:</span>
                    <span class="stat-value" id="nodeCount">0</span>
                </div>
                <div class="stat">
                    <span>Edges:</span>
                    <span class="stat-value" id="edgeCount">0</span>
                </div>
                <div class="stat">
                    <span>Circular Dependencies:</span>
                    <span class="stat-value" id="circularCount">0</span>
                </div>
                <div class="stat">
                    <span>Last Updated:</span>
                    <span class="stat-value" id="lastUpdated">-</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="network"></div>

            <div class="sidebar">
                <h3>Node Information</h3>
                <div id="nodeDetails">
                    <p style="color: #999; font-style: italic;">Click on a node to view details</p>
                </div>

                <div class="legend">
                    <h3>Legend</h3>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span class="legend-label">Services</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span class="legend-label">Packages</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9b59b6;"></div>
                        <span class="legend-label">Shared</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95a5a6;"></div>
                        <span class="legend-label">Infrastructure</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading dependency graph...</p>
    </div>

    <script>
        // Graph data and visualization
        let network = null;
        let allNodes = [];
        let allEdges = [];
        let graphData = null;

        // Color scheme
        const colors = {
            service: '#e74c3c',
            package: '#3498db',
            shared: '#9b59b6',
            infrastructure: '#95a5a6',
        };

        // Initialize the application
        async function init() {
            try {
                await loadGraph();
                setupEventListeners();
                hideLoading();
            } catch (error) {
                showError(error.message);
                hideLoading();
            }
        }

        // Load graph data
        async function loadGraph() {
            try {
                const response = await fetch('./dependency-graph.json');
                if (!response.ok) {
                    throw new Error('Could not load dependency graph. Please run: npm run visualize:deps');
                }
                graphData = await response.json();

                allNodes = graphData.nodes.map(node => ({
                    id: node.id,
                    label: node.label,
                    group: node.group,
                    level: node.level,
                    color: colors[node.type] || '#999',
                    font: { color: '#fff', size: 14 },
                    ...node,
                }));

                allEdges = graphData.edges.map((edge, index) => ({
                    id: index,
                    from: edge.from,
                    to: edge.to,
                    label: edge.label,
                    arrows: 'to',
                    dashes: edge.dashes || false,
                    ...edge,
                }));

                updateStats();
                createNetwork();
            } catch (error) {
                throw new Error(`Failed to load graph data: ${error.message}`);
            }
        }

        // Create network visualization
        function createNetwork() {
            const container = document.getElementById('network');
            const data = {
                nodes: new vis.DataSet(allNodes),
                edges: new vis.DataSet(allEdges),
            };

            const options = {
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 200,
                    },
                },
                physics: {
                    enabled: false,
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    widthConstraint: {
                        maximum: 200,
                    },
                    borderWidth: 2,
                    borderWidthSelected: 4,
                    shadow: true,
                },
                edges: {
                    smooth: {
                        type: 'cubicBezier',
                        roundness: 0.5,
                    },
                    color: {
                        color: '#848484',
                        highlight: '#667eea',
                    },
                    width: 2,
                    font: {
                        size: 12,
                        align: 'middle',
                    },
                },
                interaction: {
                    hover: true,
                    navigationButtons: true,
                    keyboard: true,
                },
            };

            network = new vis.Network(container, data, options);

            // Event listeners
            network.on('click', handleNodeClick);
            network.on('hoverNode', handleNodeHover);
        }

        // Handle node click
        function handleNodeClick(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = allNodes.find(n => n.id === nodeId);
                displayNodeDetails(node);
            }
        }

        // Handle node hover
        function handleNodeHover(params) {
            const nodeId = params.node;
            const node = allNodes.find(n => n.id === nodeId);
            if (node) {
                network.canvas.body.container.style.cursor = 'pointer';
            }
        }

        // Display node details in sidebar
        function displayNodeDetails(node) {
            const detailsDiv = document.getElementById('nodeDetails');
            const connections = allEdges.filter(e => e.from === node.id || e.to === node.id);

            let html = `
                <div class="node-info">
                    <h4>${node.label}</h4>
                    <p><strong>Type:</strong> ${node.type}</p>
                    <p><strong>Group:</strong> ${node.group}</p>
            `;

            if (node.metadata) {
                if (node.metadata.port) {
                    html += `<p><strong>Port:</strong> ${node.metadata.port}</p>`;
                }
                if (node.metadata.path) {
                    html += `<p><strong>Path:</strong> ${node.metadata.path}</p>`;
                }
                if (node.metadata.version) {
                    html += `<p><strong>Version:</strong> ${node.metadata.version}</p>`;
                }
            }

            html += `
                    <p><strong>Dependencies:</strong> ${connections.filter(e => e.from === node.id).length}</p>
                    <p><strong>Dependents:</strong> ${connections.filter(e => e.to === node.id).length}</p>
                </div>
            `;

            if (connections.length > 0) {
                html += '<h4 style="margin-top: 15px; margin-bottom: 10px;">Connections</h4>';
                connections.forEach(conn => {
                    const isOutgoing = conn.from === node.id;
                    const otherNodeId = isOutgoing ? conn.to : conn.from;
                    const otherNode = allNodes.find(n => n.id === otherNodeId);
                    const arrow = isOutgoing ? '‚Üí' : '‚Üê';

                    html += `<p style="font-size: 12px; color: #666;">${arrow} ${otherNode?.label || otherNodeId}</p>`;
                });
            }

            detailsDiv.innerHTML = html;
        }

        // Update statistics
        function updateStats() {
            document.getElementById('nodeCount').textContent = graphData.nodes.length;
            document.getElementById('edgeCount').textContent = graphData.edges.length;
            document.getElementById('circularCount').textContent = graphData.metadata.circularDependencies;
            document.getElementById('lastUpdated').textContent = new Date(graphData.metadata.generatedAt).toLocaleString();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('search').addEventListener('input', handleSearch);

            // Filter
            document.getElementById('filter').addEventListener('change', handleFilter);

            // Layout
            document.getElementById('layout').addEventListener('change', handleLayoutChange);

            // Reset
            document.getElementById('resetBtn').addEventListener('click', resetView);

            // Export
            document.getElementById('exportBtn').addEventListener('click', exportPNG);
        }

        // Handle search
        function handleSearch(event) {
            const query = event.target.value.toLowerCase();
            const filteredNodes = allNodes.filter(node =>
                node.label.toLowerCase().includes(query) ||
                node.id.toLowerCase().includes(query)
            );

            if (query && filteredNodes.length > 0) {
                network.selectNodes(filteredNodes.map(n => n.id));
                network.focus(filteredNodes[0].id, { scale: 1.5, animation: true });
            } else {
                network.unselectAll();
                network.fit();
            }
        }

        // Handle filter
        function handleFilter(event) {
            const filterValue = event.target.value;
            let filteredNodes = allNodes;
            let filteredEdges = allEdges;

            if (filterValue !== 'all') {
                filteredNodes = allNodes.filter(node => node.type === filterValue);
                const nodeIds = new Set(filteredNodes.map(n => n.id));
                filteredEdges = allEdges.filter(edge =>
                    nodeIds.has(edge.from) && nodeIds.has(edge.to)
                );
            }

            network.setData({
                nodes: new vis.DataSet(filteredNodes),
                edges: new vis.DataSet(filteredEdges),
            });
        }

        // Handle layout change
        function handleLayoutChange(event) {
            const layout = event.target.value;
            const options = { physics: { enabled: true } };

            if (layout === 'hierarchical') {
                options.layout = {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                    },
                };
                options.physics = { enabled: false };
            } else if (layout === 'force') {
                options.layout = { randomSeed: 2 };
            } else if (layout === 'circular') {
                options.layout = { randomSeed: 2 };
            }

            network.setOptions(options);
            setTimeout(() => {
                network.setOptions({ physics: { enabled: false } });
            }, 3000);
        }

        // Reset view
        function resetView() {
            network.fit({ animation: true });
            document.getElementById('search').value = '';
            document.getElementById('filter').value = 'all';
            network.setData({
                nodes: new vis.DataSet(allNodes),
                edges: new vis.DataSet(allEdges),
            });
        }

        // Export to PNG
        function exportPNG() {
            const canvas = document.querySelector('#network canvas');
            const link = document.createElement('a');
            link.download = 'orion-dependency-graph.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Show error
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            container.appendChild(errorDiv);
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
